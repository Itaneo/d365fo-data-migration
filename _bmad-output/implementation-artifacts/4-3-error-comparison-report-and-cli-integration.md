# Story 4.3: Error Comparison Report & CLI Integration

Status: done

<!-- Note: Validation is optional. Run validate-create-story for quality check before dev-story. -->

## Story

As a Functional Consultant,
I want a markdown error comparison report generated after each migration cycle,
So that I can immediately see new vs. known errors without manual comparison.

## Acceptance Criteria

1. **Given** error comparison results are available, **When** the report is generated, **Then** a markdown file is written to the output directory following the architecture report format: title, generated timestamp, cycle ID, summary table, per-entity breakdown (FR11)
2. **And** entity names use code formatting (`` `CustCustomerV3Entity` ``) and status indicators use `pass`/`FAIL`/`warn` convention
3. **And** the report clearly shows count of new errors, carry-over errors, and resolved errors per entity (FR12)
4. **And** report generation completes within seconds (NFR10)
5. **Given** the existing CLI commands, **When** `--compare` flag is added per ADR-5, **Then** `[Option("compare")] bool compare = false` is available on all migration commands (FR21)
6. **And** when `--compare` is true, error comparison report is auto-generated after the migration run
7. **And** a standalone `compare-errors` / `ce` command generates the report independently
8. **And** `compare-errors` accepts `[Option("cycle")] string? cycleId = null` to compare against a specific cycle instead of latest
9. **And** report output path can be overridden via `[Option("output")] string? outputPath = null` (FR22)
10. **And** missing historical data is handled gracefully with informative messages (NFR9)

## Tasks / Subtasks

- [x] Task 1: Create error comparison report generator service (AC: #1, #2, #3, #4)
  - [x] 1.1 Create `Comparison/IErrorComparisonReportService.cs` interface with method: `Task<string> GenerateReportAsync(ComparisonResult comparison, CancellationToken cancellationToken = default)` returning the file path of the written report
  - [x] 1.2 Create `Comparison/ErrorComparisonReportService.cs` implementing `IErrorComparisonReportService`:
    - Constructor injects: `IOptions<DestinationSettings>`, `ILogger<ErrorComparisonReportService>`
    - `GenerateReportAsync` logic:
      1. Determine output path: use `outputPath` parameter if provided, else `{DestinationSettings.OutputDirectory}/error-comparison-{cycleId}.md`
      2. Build markdown report following architecture report format pattern (architecture.md#Markdown Report Format Pattern)
      3. Write report to file
      4. Return the file path
  - [x] 1.3 Add optional `outputPath` parameter to `GenerateReportAsync`: `Task<string> GenerateReportAsync(ComparisonResult comparison, string? outputPath = null, CancellationToken cancellationToken = default)`
  - [x] 1.4 Handle first-cycle case: if `comparison.IsFirstCycle == true`, generate a report stating "First cycle -- no comparison available" with current cycle ID and timestamp. Do NOT return an error or skip report generation

- [x] Task 2: Implement markdown report content (AC: #1, #2, #3)
  - [x] 2.1 Report header:
    ```markdown
    # Error Comparison Report

    **Generated:** {ISO 8601 timestamp}
    **Current Cycle:** {currentCycleId}
    **Previous Cycle:** {previousCycleId}
    ```
  - [x] 2.2 Summary section:
    ```markdown
    ## Summary

    | Metric | Count |
    |--------|-------|
    | New Errors | {totalNew} |
    | Carry-Over Errors | {totalCarryOver} |
    | Resolved Errors | {totalResolved} |
    | Total Current Errors | {totalNew + totalCarryOver} |
    ```
  - [x] 2.3 Per-entity breakdown section:
    ```markdown
    ## Entity Details

    ### `CustCustomerV3Entity` - FAIL

    | Type | Count |
    |------|-------|
    | New | 3 |
    | Carry-Over | 2 |
    | Resolved | 1 |

    **New Errors:**
    - `[abc123def456789a]` Error message text here

    **Carry-Over Errors:**
    - `[def456abc789012b]` Error message text here

    **Resolved (from previous cycle):**
    - `[789012def345678c]`
    ```
  - [x] 2.4 Status indicator logic: `EntityStatus.Failed` -> `FAIL`, `EntityStatus.Success` -> `pass`, `EntityStatus.Warning` -> `warn`, `EntityStatus.Skipped` -> `skip`
  - [x] 2.5 Entities with zero new errors, zero carry-over errors, AND zero resolved errors should NOT appear in the entity details section (already filtered by `ErrorComparisonService`)
  - [x] 2.6 Footer:
    ```markdown
    ---
    *Generated by d365fo-data-migration*
    ```
  - [x] 2.7 First-cycle report format:
    ```markdown
    # Error Comparison Report

    **Generated:** {ISO 8601 timestamp}
    **Current Cycle:** {currentCycleId}

    ## Summary

    First cycle -- no comparison available. Run another migration cycle to enable error comparison.

    ---
    *Generated by d365fo-data-migration*
    ```

- [x] Task 3: Add `--compare` flag to existing migration commands (AC: #5, #6)
  - [x] 3.1 Add `[Option("compare")] bool compare = false` parameter to `RunExportToFileAsync`, `RunExportToPackageAsync`, and `RunImportDynamicsAsync` in `CommandHandler.cs`
  - [x] 3.2 Inject `IErrorComparisonService` and `IErrorComparisonReportService` into `CommandHandler` constructor
  - [x] 3.3 After `PersistResultAsync(result, cancellationToken)` and before exit code return, add:
    ```csharp
    if (compare)
    {
        await GenerateComparisonReportAsync(cancellationToken);
    }
    ```
  - [x] 3.4 Create private helper `GenerateComparisonReportAsync`:
    ```csharp
    private async Task GenerateComparisonReportAsync(
        string? outputPath = null,
        string? cycleId = null,
        CancellationToken cancellationToken = default)
    {
        try
        {
            var comparison = await _comparisonService.CompareAsync(
                currentCycleId: null, previousCycleId: cycleId, cancellationToken: cancellationToken);
            var reportPath = await _reportService.GenerateReportAsync(
                comparison, outputPath, cancellationToken);
            _logger.LogInformation("Error comparison report written to {ReportPath}", reportPath);
        }
        catch (Exception ex)
        {
            _logger.LogWarning(ex, "Failed to generate error comparison report");
        }
    }
    ```
  - [x] 3.5 Report generation failures must NOT change exit codes -- wrap in try/catch (non-fatal), same pattern as `PersistResultAsync`

- [x] Task 4: Add standalone `compare-errors` / `ce` command (AC: #7, #8, #9, #10)
  - [x] 4.1 Add new command in `CommandHandler.cs`:
    ```csharp
    [Command("compare-errors", Aliases = new[] { "ce" }, Description = "Generate error comparison report from recent migration cycles")]
    public async Task<int> RunCompareErrorsAsync(
        [Option("cycle")] string? cycleId = null,
        [Option("output")] string? outputPath = null,
        CancellationToken cancellationToken = default)
    ```
  - [x] 4.2 Implementation:
    1. Call `_comparisonService.CompareAsync(currentCycleId: null, previousCycleId: cycleId, cancellationToken)`
    2. Call `_reportService.GenerateReportAsync(comparison, outputPath, cancellationToken)`
    3. Log the report file path
    4. Return exit code 0 on success
    5. Return exit code 1 if comparison had warnings (e.g., first cycle)
    6. Return exit code 2 for configuration errors
  - [x] 4.3 Handle the `--cycle` option: when provided, the comparison engine compares the latest cycle against the specified cycle ID instead of the second-latest
  - [x] 4.4 Handle first-cycle case: generate the first-cycle report (no errors to compare), log "First cycle -- no comparison available", return exit code 0 (NFR9)
  - [x] 4.5 Handle no-cycles case: log "No cycle results found", return exit code 1

- [x] Task 5: Register new services in Program.cs (AC: all)
  - [x] 5.1 Add DI registration:
    ```csharp
    // Reporting
    builder.Services.AddTransient<IErrorComparisonReportService, ErrorComparisonReportService>();
    ```
  - [x] 5.2 Place registration AFTER the "Error Analysis" section in Program.cs (after line 73)
  - [x] 5.3 Add required `using` statement: the `Comparison` namespace is already imported

- [x] Task 6: Write unit tests for report generator (AC: #1, #2, #3, #4, #10)
  - [x] 6.1 Create `Unit/Comparison/ErrorComparisonReportServiceTests.cs` with tests:
    - `GenerateReportAsync_WithComparison_WritesMarkdownFile` -- verify file is created
    - `GenerateReportAsync_ReportContainsHeader_WithCycleIds` -- verify title, generated timestamp, cycle IDs
    - `GenerateReportAsync_ReportContainsSummaryTable_WithCorrectCounts` -- verify new/carry-over/resolved counts
    - `GenerateReportAsync_ReportContainsEntityDetails_WithCodeFormatting` -- verify entity names in backticks
    - `GenerateReportAsync_ReportContainsStatusIndicators_CorrectFormat` -- verify FAIL/pass/warn convention
    - `GenerateReportAsync_ReportContainsNewErrors_WithFingerprints` -- verify new error listing
    - `GenerateReportAsync_ReportContainsCarryOverErrors_WithFingerprints` -- verify carry-over listing
    - `GenerateReportAsync_ReportContainsResolvedFingerprints` -- verify resolved listing
    - `GenerateReportAsync_FirstCycle_GeneratesFirstCycleReport` -- verify first-cycle message
    - `GenerateReportAsync_CustomOutputPath_WritesToSpecifiedPath` -- verify output path override
    - `GenerateReportAsync_DefaultOutputPath_UsesOutputDirectory` -- verify default path
    - `GenerateReportAsync_ReportContainsFooter` -- verify footer
    - `GenerateReportAsync_CompletesInUnderOneSecond` -- performance (NFR10)

- [x] Task 7: Write integration tests for CLI compare flag and standalone command (AC: #5, #6, #7, #8, #9)
  - [x] 7.1 Create `Integration/Comparison/CompareErrorsCommandTests.cs` with tests using mocked services:
    - `RunCompareErrorsAsync_TwoCyclesExist_GeneratesReportAndReturnsZero`
    - `RunCompareErrorsAsync_FirstCycle_GeneratesFirstCycleReportAndReturnsZero`
    - `RunCompareErrorsAsync_NoCycles_ReturnsOne`
    - `RunCompareErrorsAsync_WithCycleOption_PassesCycleIdToService`
    - `RunCompareErrorsAsync_WithOutputOption_PassesOutputPathToService`
    - `CompareFlag_AfterMigration_TriggersReportGeneration` -- verify `--compare` flag triggers report after migration
    - `CompareFlag_ReportFailure_DoesNotChangeExitCode` -- verify non-fatal

- [x] Task 8: Build verification and full test suite (AC: all)
  - [x] 8.1 Run `dotnet build` -- zero errors, zero warnings
  - [x] 8.2 Run `dotnet test` -- all 164 existing tests pass plus all new tests
  - [x] 8.3 Verify backward compatibility: existing tests (fingerprinter, comparison service, persistence, pipeline) unchanged
  - [x] 8.4 Verify that `--compare` flag defaults to false (existing migration commands unchanged when flag not specified)
  - [x] 8.5 Verify standalone `compare-errors` / `ce` command is registered and accessible

## Dev Notes

### Recommended Implementation Sequence

Tasks should be implemented in numerical order (1 through 8). Key dependencies:
- Task 1 (report service interface + implementation) has no dependencies beyond existing `ComparisonResult` model
- Task 2 (markdown content) is implemented within Task 1 -- listed separately for clarity
- Task 3 (`--compare` flag) requires Tasks 1-2
- Task 4 (standalone command) requires Tasks 1-2
- Task 5 (DI registration) requires Task 1
- Tasks 6-7 (tests) require the code from Tasks 1-5
- Task 8 (build verification) is always last

### Purpose

This is the third and final story in Epic 4 (Migration Result Persistence & Error Comparison). It builds on Story 4.1's result persistence and Story 4.2's error fingerprinting/comparison engine to deliver: (1) a markdown error comparison report generator service, (2) `--compare` flag on existing migration commands for auto-report generation, and (3) a standalone `compare-errors` / `ce` CLI command. This completes the Functional Consultant's Journey 3 (Error Triage).

### Critical Architecture Constraints

**ADR-5 (Report Generation Architecture):**
- Hybrid: auto-generate after run (opt-in via `--compare` flag) + standalone commands
- `compare-errors` / `ce` standalone command generates report independently
- `[Option("cycle")] string? cycleId = null` to compare against specific cycle
- `[Option("output")] string? outputPath = null` for output path override
- Report generation failures are NON-FATAL -- they must not change exit codes

**ADR-8 (Exit Code Contract):**
- `compare-errors` command: 0 = success, 1 = partial/no data, 2 = config error
- `--compare` flag on migration commands: report failure does NOT change migration exit code
- First-cycle case returns exit code 0 (NFR9) -- generating a first-cycle report is not an error

**Architecture Markdown Report Format Pattern:**
```markdown
# {Report Title}

**Generated:** {ISO 8601 timestamp}
**Cycle:** {cycle ID}

## Summary

{Key metrics table}

## Details

{Per-entity breakdown}

---
*Generated by d365fo-data-migration v{version}*
```

- Reports are self-contained markdown files (no external CSS/assets)
- Tables for summary data, lists for details
- Entity names in code formatting: `` `CustCustomerV3Entity` ``
- Status indicators: `pass` / `FAIL` / `warn` (lowercase for pass/warn, uppercase FAIL for visibility)

### Previous Story Intelligence

**Story 4.2 (Error Fingerprinting & Comparison Engine) -- DONE:**
- Created `Fingerprinting/` folder with `IErrorFingerprinter`, `ErrorFingerprinter`
- Created `Comparison/` folder with `IErrorComparisonService`, `ErrorComparisonService`
- Created `Comparison/Models/` with `ComparisonResult`, `EntityComparisonResult`, `ClassifiedError`, `ErrorClassification`
- `ComparisonResult` has: `CurrentCycleId`, `PreviousCycleId`, `Timestamp`, `IsFirstCycle`, `EntityComparisons`, `TotalNewErrors`, `TotalCarryOverErrors`, `TotalResolvedErrors`
- `EntityComparisonResult` has: `EntityName`, `CurrentStatus`, `NewErrors`, `CarryOverErrors`, `ResolvedFingerprints`
- `ClassifiedError` has: `EntityName`, `Message`, `Fingerprint`, `Classification`, `Category`
- `ErrorComparisonService.CompareAsync()` handles: two cycles (normal), first cycle (IsFirstCycle=true), no cycles (IsFirstCycle=true)
- `ErrorComparisonService` uses `IMigrationResultRepository.GetLatestCycleResultsAsync(2)` for latest comparison
- `ErrorComparisonService` accepts optional `currentCycleId` and `previousCycleId` parameters
- **Test count: 164 tests passing**
- Code review fixes applied: consistent timestamp sourcing, CancellationToken propagation, GroupBy for duplicate entity safety

**Story 4.1 (Result Persistence & Credential Sanitization) -- DONE:**
- `IMigrationResultRepository` with `SaveCycleResultAsync`, `GetCycleResultAsync`, `GetLatestCycleResultsAsync`, `ListCycleIdsAsync`
- `JsonFileMigrationResultRepository` implements atomic writes, sanitization before persistence
- `IResultSanitizer` / `RegexResultSanitizer` for credential stripping
- `PersistenceSettings` with `ResultsDirectory` (defaults to `{OutputDirectory}/results/`)
- `JsonDefaults.ResultJsonOptions` for consistent serialization
- `CommandHandler` already has `PersistResultAsync` helper pattern (try/catch, non-fatal)

**Story 3.2 (Exit Code Standardization) -- DONE:**
- Exit code contract: 0 (success), 1 (partial failure), 2 (config error)
- `CommandHandler` has try/catch for `EntityValidationException` (exit 2), `OperationCanceledException` (exit 1), general `Exception` (exit 1)

### Git Intelligence

**Recent commits (latest first):**
- `7402d78` Story 4.2: Error fingerprinting and comparison engine (#14)
- `5af6c0a` Story 4.1: Result persistence and credential sanitization (#13)
- `5fc24b1` Story 3.2: Exit code standardization and CLI config overrides (#12)
- `a39e4ac` Story 3.1: CLI entity selection flag (#11)

**Key code structure from Story 4.2:**
- `Comparison/ErrorComparisonService.cs`: `CompareAsync` method, `BuildComparison` static method
- `Comparison/IErrorComparisonService.cs`: single `CompareAsync` method with optional `currentCycleId`, `previousCycleId`, `cancellationToken`
- `Comparison/Models/ComparisonResult.cs`: all comparison data needed for report generation
- `Program.cs`: `IErrorComparisonService` registered as Transient (line 73)

**Key code structure from Story 4.1:**
- `CommandHandler.cs`: `PersistResultAsync` helper (try/catch non-fatal pattern) -- use as model for `GenerateComparisonReportAsync`
- `CommandHandler.cs`: `ParseEntityFilter` static helper for comma parsing
- `Program.cs`: DI registrations grouped by capability with comment headers

### Project Structure Notes

**Files to CREATE:**
```
Dynamics365ImportData/Dynamics365ImportData/Comparison/
  IErrorComparisonReportService.cs
  ErrorComparisonReportService.cs

Dynamics365ImportData/Dynamics365ImportData.Tests/Unit/Comparison/
  ErrorComparisonReportServiceTests.cs

Dynamics365ImportData/Dynamics365ImportData.Tests/Integration/Comparison/
  CompareErrorsCommandTests.cs
```

**Files to MODIFY:**
```
Dynamics365ImportData/Dynamics365ImportData/CommandHandler.cs
  -> Add IErrorComparisonService and IErrorComparisonReportService to constructor injection
  -> Add [Option("compare")] bool compare = false to all three migration commands
  -> Add GenerateComparisonReportAsync private helper method
  -> Add compare-errors / ce standalone command
  -> Call GenerateComparisonReportAsync after PersistResultAsync when compare == true

Dynamics365ImportData/Dynamics365ImportData/Program.cs
  -> Add DI registration for IErrorComparisonReportService (Transient)
```

**Files NOT to modify:**
- `Comparison/IErrorComparisonService.cs` -- interface unchanged
- `Comparison/ErrorComparisonService.cs` -- implementation unchanged
- `Comparison/Models/` -- all models unchanged
- `Persistence/` -- all files unchanged
- `Sanitization/` -- all files unchanged
- `Fingerprinting/` -- all files unchanged
- `Pipeline/MigrationPipelineService.cs` -- no changes needed
- `Pipeline/CycleResult.cs` -- no changes needed
- `Pipeline/IMigrationPipelineService.cs` -- interface unchanged
- `appsettings.json` -- no new config sections needed (report uses DestinationSettings.OutputDirectory)

### Architecture Compliance

**Folder structure:** New report service goes in existing `Comparison/` folder (per architecture.md, report generation is part of the comparison capability). Namespace: `Dynamics365ImportData.Comparison`.

**DI lifetime rules:**
- `IErrorComparisonReportService` -> **Transient** (may hold per-report state, consistent with `IErrorComparisonService`)

**One interface + one implementation per file.** Interface file named `IErrorComparisonReportService.cs`, implementation named `ErrorComparisonReportService.cs`. Both in `Comparison/` folder.

### Library & Framework Requirements

- **System.IO** (included in .NET 10) -- for file writing
- **System.Text** (included in .NET 10) -- for `StringBuilder` report assembly
- **No new NuGet packages required**

### Technical Implementation Details

**Existing ComparisonResult model (from Comparison/Models/ComparisonResult.cs):**
```csharp
public class ComparisonResult
{
    public string CurrentCycleId { get; set; } = string.Empty;
    public string? PreviousCycleId { get; set; }
    public DateTimeOffset Timestamp { get; set; }
    public bool IsFirstCycle { get; set; }
    public List<EntityComparisonResult> EntityComparisons { get; set; } = new();
    public int TotalNewErrors { get; set; }
    public int TotalCarryOverErrors { get; set; }
    public int TotalResolvedErrors { get; set; }
}
```

**Existing EntityComparisonResult model (from Comparison/Models/EntityComparisonResult.cs):**
```csharp
public class EntityComparisonResult
{
    public string EntityName { get; set; } = string.Empty;
    public EntityStatus CurrentStatus { get; set; }
    public List<ClassifiedError> NewErrors { get; set; } = new();
    public List<ClassifiedError> CarryOverErrors { get; set; } = new();
    public List<string> ResolvedFingerprints { get; set; } = new();
}
```

**Existing ClassifiedError model (from Comparison/Models/ClassifiedError.cs):**
```csharp
public class ClassifiedError
{
    public string EntityName { get; set; } = string.Empty;
    public string Message { get; set; } = string.Empty;
    public string Fingerprint { get; set; } = string.Empty;
    public ErrorClassification Classification { get; set; }
    public ErrorCategory Category { get; set; }
}
```

**Report service interface:**
```csharp
public interface IErrorComparisonReportService
{
    Task<string> GenerateReportAsync(
        ComparisonResult comparison,
        string? outputPath = null,
        CancellationToken cancellationToken = default);
}
```

**Report generation pattern (ErrorComparisonReportService.cs):**
```csharp
public class ErrorComparisonReportService : IErrorComparisonReportService
{
    private readonly IOptions<DestinationSettings> _destinationSettings;
    private readonly ILogger<ErrorComparisonReportService> _logger;

    public ErrorComparisonReportService(
        IOptions<DestinationSettings> destinationSettings,
        ILogger<ErrorComparisonReportService> logger)
    {
        _destinationSettings = destinationSettings;
        _logger = logger;
    }

    public async Task<string> GenerateReportAsync(
        ComparisonResult comparison,
        string? outputPath = null,
        CancellationToken cancellationToken = default)
    {
        var markdown = BuildMarkdown(comparison);
        var filePath = outputPath ?? GetDefaultOutputPath(comparison);

        var directory = Path.GetDirectoryName(filePath);
        if (!string.IsNullOrEmpty(directory))
            Directory.CreateDirectory(directory);

        await File.WriteAllTextAsync(filePath, markdown, cancellationToken);
        _logger.LogInformation("Error comparison report written to {ReportPath}", filePath);
        return filePath;
    }

    private string GetDefaultOutputPath(ComparisonResult comparison)
    {
        var outputDir = _destinationSettings.Value.OutputDirectory ?? ".";
        var cycleId = comparison.CurrentCycleId;
        return Path.Combine(outputDir, $"error-comparison-{cycleId}.md");
    }

    private static string BuildMarkdown(ComparisonResult comparison)
    {
        var sb = new StringBuilder();
        // Build report sections...
        return sb.ToString();
    }
}
```

**Status indicator mapping:**
```csharp
private static string FormatStatus(EntityStatus status) => status switch
{
    EntityStatus.Failed => "FAIL",
    EntityStatus.Success => "pass",
    EntityStatus.Warning => "warn",
    EntityStatus.Skipped => "skip",
    _ => status.ToString().ToLowerInvariant()
};
```

**CommandHandler modifications -- constructor change:**
```csharp
// CURRENT constructor:
public CommandHandler(
    IMigrationPipelineService pipelineService,
    SourceQueryCollection queries,
    IMigrationResultRepository resultRepository,
    ILogger<CommandHandler> logger)

// MODIFIED constructor:
public CommandHandler(
    IMigrationPipelineService pipelineService,
    SourceQueryCollection queries,
    IMigrationResultRepository resultRepository,
    IErrorComparisonService comparisonService,
    IErrorComparisonReportService reportService,
    ILogger<CommandHandler> logger)
```

**CommandHandler modifications -- migration command signature (example for export-file):**
```csharp
[Command("export-file", Aliases = new[] { "f" }, Description = "Exports the queries to Xml files")]
public async Task<int> RunExportToFileAsync(
    [Option("entities")] string? entities = null,
    [Option("compare")] bool compare = false,
    CancellationToken cancellationToken = default)
```

**CommandHandler modifications -- after PersistResultAsync:**
```csharp
await PersistResultAsync(result, cancellationToken);
if (compare)
{
    await GenerateComparisonReportAsync(cancellationToken: cancellationToken);
}
return result.Failed > 0 ? 1 : 0;
```

**Standalone compare-errors command:**
```csharp
[Command("compare-errors", Aliases = new[] { "ce" }, Description = "Generate error comparison report from recent migration cycles")]
public async Task<int> RunCompareErrorsAsync(
    [Option("cycle")] string? cycleId = null,
    [Option("output")] string? outputPath = null,
    CancellationToken cancellationToken = default)
{
    try
    {
        var comparison = await _comparisonService.CompareAsync(
            currentCycleId: null, previousCycleId: cycleId, cancellationToken: cancellationToken);
        var reportPath = await _reportService.GenerateReportAsync(
            comparison, outputPath, cancellationToken);
        _logger.LogInformation("Error comparison report generated: {ReportPath}", reportPath);
        return comparison.IsFirstCycle ? 0 : 0;
    }
    catch (OperationCanceledException)
    {
        _logger.LogWarning("Error comparison was canceled");
        return 1;
    }
    catch (Exception ex)
    {
        _logger.LogError(ex, "Failed to generate error comparison report");
        return 1;
    }
}
```

**Existing ExitCodeTests consideration:**
- `ExitCodeTests.cs` constructs `CommandHandler` -- the constructor now requires 2 new parameters: `IErrorComparisonService` and `IErrorComparisonReportService`. These must be provided as mocks (NSubstitute: `Substitute.For<IErrorComparisonService>()`, `Substitute.For<IErrorComparisonReportService>()`)
- All existing ExitCodeTests should continue to pass since the `--compare` flag defaults to `false`

### Testing Requirements

**Test patterns:** Follow `{Method}_{Scenario}_{ExpectedResult}` naming. Shouldly assertions. Arrange/Act/Assert with comment markers. Inline test data (no external files). Use temp directories for file I/O tests.

**Existing test infrastructure to be aware of:**
- `Integration/Pipeline/ExitCodeTests.cs` -- constructs `CommandHandler` with mocked services. **WILL NEED UPDATING** for new constructor parameters (`IErrorComparisonService`, `IErrorComparisonReportService`)
- `Unit/Comparison/ErrorComparisonServiceTests.cs` -- 10 existing tests for comparison logic. These should NOT change
- `Integration/Fingerprinting/FingerprintPersistenceTests.cs` -- 2 existing tests. These should NOT change
- All 164 existing tests should continue to pass unchanged (except `ExitCodeTests` constructor updates)

**Thread safety consideration:** Report generation is single-threaded (called after migration completes). No concurrency concerns for the report service.

### Critical Guardrails

1. **DO NOT modify `IErrorComparisonService` interface** -- it already has the exact API needed. The comparison service is consumed, not changed
2. **DO NOT modify `ComparisonResult` or other comparison models** -- they already contain all data needed for the report
3. **DO NOT modify `ErrorComparisonService`** -- the comparison engine is complete from Story 4.2
4. **DO NOT change exit codes for migration commands when `--compare` fails** -- report generation is NON-FATAL, wrapped in try/catch. Migration exit code reflects migration result only
5. **DO use the existing `PersistResultAsync` pattern** as the model for `GenerateComparisonReportAsync` -- both are non-fatal post-migration operations
6. **DO default `--compare` to `false`** -- existing automation scripts must not break
7. **DO handle first-cycle case gracefully** -- generate a first-cycle report, don't error. Return exit code 0 per NFR9
8. **DO use `DestinationSettings.OutputDirectory`** for the default report output path (same base directory as migration output)
9. **DO use Serilog structured message templates** for all logging -- NOT string interpolation
10. **DO propagate CancellationToken** through all async call chains
11. **DO register `IErrorComparisonReportService` as Transient** -- per architecture DI lifetime rules
12. **DO update `ExitCodeTests`** constructor calls with new mock parameters for `IErrorComparisonService` and `IErrorComparisonReportService`
13. **DO use `StringBuilder`** for markdown assembly -- efficient for multi-section string building
14. **DO create output directory if it doesn't exist** before writing the report file

### Anti-Patterns to Avoid

- DO NOT use `Console.WriteLine` for output -- use Serilog `_logger.Information`
- DO NOT use string interpolation in Serilog messages -- use structured templates
- DO NOT let report generation failures crash the migration -- always try/catch
- DO NOT modify the comparison engine or models -- this story only CONSUMES them
- DO NOT add readiness report logic -- that's Epic 5 (Story 5.1/5.2)
- DO NOT create static helper classes -- use DI-injected services
- DO NOT hardcode file paths -- use `IOptions<DestinationSettings>` configuration
- DO NOT catch exceptions without logging them
- DO NOT add `ReportSettings` configuration -- that's for readiness reports in Epic 5. Error comparison uses `DestinationSettings.OutputDirectory` for output path

### Performance Considerations

- Report generation is a simple string-building + file-write operation. Expected completion: < 100ms (NFR10)
- `StringBuilder` used for efficient string concatenation
- No large data processing -- `ComparisonResult` is already computed by the comparison engine
- File write is a single atomic operation (small markdown file)

### Report Output Examples

**Normal comparison (two cycles with errors):**
```markdown
# Error Comparison Report

**Generated:** 2026-02-01T14:30:00+00:00
**Current Cycle:** cycle-2026-02-01T143000
**Previous Cycle:** cycle-2026-01-31T220000

## Summary

| Metric | Count |
|--------|-------|
| New Errors | 3 |
| Carry-Over Errors | 5 |
| Resolved Errors | 2 |
| Total Current Errors | 8 |

## Entity Details

### `CustCustomerV3Entity` - FAIL

| Type | Count |
|------|-------|
| New | 2 |
| Carry-Over | 3 |
| Resolved | 1 |

**New Errors:**
- `[a1b2c3d4e5f6a7b8]` Record validation failed: field CUSTACCOUNT required but missing
- `[f8e7d6c5b4a39281]` Data type mismatch: expected decimal, got string for field CREDITMAX

**Carry-Over Errors:**
- `[1234567890abcdef]` Foreign key violation: referenced DIRPARTYTABLE record not found
- `[abcdef1234567890]` Duplicate key: CUSTACCOUNT already exists in target
- `[fedcba0987654321]` Field length exceeded: CUSTNAME max 100 characters

**Resolved (from previous cycle):**
- `[9876543210fedcba]`

### `VendVendorV2Entity` - pass

| Type | Count |
|------|-------|
| New | 1 |
| Carry-Over | 2 |
| Resolved | 1 |

**New Errors:**
- `[c3d4e5f6a7b8c9d0]` Missing mandatory field: VENDGROUP

**Carry-Over Errors:**
- `[d0c9b8a7f6e5d4c3]` Payment terms validation: PAYMTERMID not found in target
- `[e5f6a7b8c9d0e1f2]` Address validation: invalid postal code format

**Resolved (from previous cycle):**
- `[f2e1d0c9b8a7f6e5]`

---
*Generated by d365fo-data-migration*
```

**First cycle (no previous data):**
```markdown
# Error Comparison Report

**Generated:** 2026-02-01T14:30:00+00:00
**Current Cycle:** cycle-2026-02-01T143000

## Summary

First cycle -- no comparison available. Run another migration cycle to enable error comparison.

---
*Generated by d365fo-data-migration*
```

### References

- [Source: architecture.md#ADR-5: Report Generation Architecture]
- [Source: architecture.md#ADR-8: Exit Code Contract]
- [Source: architecture.md#Markdown Report Format Pattern]
- [Source: architecture.md#DI Registration Pattern]
- [Source: architecture.md#Folder & Namespace Organization]
- [Source: architecture.md#Error Handling Pattern]
- [Source: architecture.md#Serilog Message Template Pattern]
- [Source: architecture.md#Test Naming & Style Pattern]
- [Source: epics.md#Story 4.3: Error Comparison Report & CLI Integration]
- [Source: prd.md#FR9-FR12: Error comparison and report generation]
- [Source: prd.md#FR21-FR22: Per-run report toggle and output overrides]
- [Source: prd.md#NFR9: Graceful degradation for missing historical data]
- [Source: prd.md#NFR10: Report generation within seconds]
- [Source: 4-2-error-fingerprinting-and-comparison-engine.md (previous story intelligence)]
- [Source: 4-1-result-persistence-and-credential-sanitization.md (previous story intelligence)]
- [Source: Dynamics365ImportData/Dynamics365ImportData/Comparison/IErrorComparisonService.cs -- CompareAsync interface]
- [Source: Dynamics365ImportData/Dynamics365ImportData/Comparison/ErrorComparisonService.cs -- CompareAsync implementation]
- [Source: Dynamics365ImportData/Dynamics365ImportData/Comparison/Models/ComparisonResult.cs -- report input model]
- [Source: Dynamics365ImportData/Dynamics365ImportData/Comparison/Models/EntityComparisonResult.cs -- per-entity comparison data]
- [Source: Dynamics365ImportData/Dynamics365ImportData/Comparison/Models/ClassifiedError.cs -- classified error with fingerprint]
- [Source: Dynamics365ImportData/Dynamics365ImportData/Comparison/Models/ErrorClassification.cs -- New/CarryOver enum]
- [Source: Dynamics365ImportData/Dynamics365ImportData/Persistence/Models/EntityStatus.cs -- Success/Failed/Warning/Skipped enum]
- [Source: Dynamics365ImportData/Dynamics365ImportData/Persistence/IMigrationResultRepository.cs -- GetLatestCycleResultsAsync for comparison]
- [Source: Dynamics365ImportData/Dynamics365ImportData/CommandHandler.cs -- existing command patterns, PersistResultAsync helper, constructor injection]
- [Source: Dynamics365ImportData/Dynamics365ImportData/Program.cs -- DI registration patterns (line 67-73)]
- [Source: Dynamics365ImportData/Dynamics365ImportData/Settings/DestinationSettings.cs -- OutputDirectory for default report path]
- [Source: Dynamics365ImportData/Dynamics365ImportData/appsettings.json -- DestinationSettings configuration]

## Dev Agent Record

### Agent Model Used

Claude Opus 4.5 (claude-opus-4-5-20251101)

### Debug Log References

- Build: `dotnet build` -- 0 errors, 34 warnings (all pre-existing xUnit1051 warnings)
- Tests: `dotnet test` -- 184 passed (164 existing + 20 new), 0 failed, 0 skipped

### Completion Notes List

- Created `IErrorComparisonReportService` interface with `GenerateReportAsync` accepting `ComparisonResult`, optional `outputPath`, and `CancellationToken`
- Implemented `ErrorComparisonReportService` with full markdown report generation: header (title, timestamp, cycle IDs), summary table (new/carry-over/resolved/total counts), per-entity breakdown with code-formatted entity names, status indicators (FAIL/pass/warn/skip), error listings with fingerprints, and footer
- First-cycle case generates a simplified report with "First cycle -- no comparison available" message
- Custom output path support with directory auto-creation; default path uses `DestinationSettings.OutputDirectory`
- Added `--compare` flag (defaults to false) to all three migration commands: `export-file`, `export-package`, `import-d365`
- Report generation after migration is non-fatal (try/catch, follows `PersistResultAsync` pattern)
- Added standalone `compare-errors` / `ce` command with `--cycle` and `--output` options
- Standalone command returns 0 on success (including first-cycle), 1 on errors
- Registered `IErrorComparisonReportService` as Transient in DI container
- Updated `ExitCodeTests` constructor calls with new mock parameters for `IErrorComparisonService` and `IErrorComparisonReportService`
- 13 unit tests covering: file creation, header/cycle IDs, summary table, entity code formatting, status indicators, new/carry-over/resolved error listings, first-cycle report, custom/default output paths, footer, performance (<1s)
- 7 integration tests covering: standalone command (success, first-cycle, no-cycles, --cycle option, --output option), --compare flag triggering report, report failure non-fatal

### Senior Developer Review (AI)

**Review Date:** 2026-02-02
**Review Outcome:** Approve (with fixes applied)
**Reviewer Model:** Claude Opus 4.5 (claude-opus-4-5-20251101)

**Issues Found:** 3 High, 3 Medium, 2 Low

**Action Items:**

- [x] [HIGH] Fix `compare-errors` no-cycles case: returns 0 instead of 1 per Task 4.5 spec. `ErrorComparisonService` returns `IsFirstCycle=true` with empty `CurrentCycleId` for no-cycles (doesn't throw). Added early return check in `RunCompareErrorsAsync`.
- [x] [HIGH] No distinction between "first cycle" and "no cycles" in `RunCompareErrorsAsync`. Fixed by checking `IsFirstCycle && string.IsNullOrEmpty(CurrentCycleId)` to detect no-cycles.
- [x] [MEDIUM] Dead parameters `outputPath` and `cycleId` on `GenerateComparisonReportAsync` helper -- never passed by any caller. Removed unused parameters.
- [x] [MEDIUM] Test `RunCompareErrorsAsync_NoCycles_ReturnsOne` mocked `CompareAsync` to throw exception, but real service never throws for no-cycles. Fixed test to mock actual return value.
- [ ] [MEDIUM] Duplicate code pattern across three migration commands (pre-existing debt amplified by this story). Not fixed -- would be scope creep to refactor command structure in a review.
- [ ] [LOW] First-cycle report uses `## Summary` header with prose instead of table, inconsistent with normal reports. By design per story spec Task 2.7.
- [ ] [LOW] Duplicate `SourceQueryCollection` test setup in `CompareErrorsCommandTests` and `ExitCodeTests`. Test infrastructure improvement, not blocking.
- [x] [INFO] Misleading task 4.2 description item 5 says "Return exit code 1 if comparison had warnings (e.g., first cycle)" but code correctly returns 0 per ADR-8/NFR9. Code is correct, task description was ambiguous.

### Change Log

- 2026-02-02: Implemented Story 4.3 -- Error comparison report generator service, --compare flag on migration commands, standalone compare-errors/ce command, 20 new tests (184 total)
- 2026-02-02: Code review fixes -- Fixed no-cycles exit code (0 â†’ 1), removed dead parameters from GenerateComparisonReportAsync, fixed NoCycles test to mock real service behavior

### File List

**New files:**
- `Dynamics365ImportData/Dynamics365ImportData/Comparison/IErrorComparisonReportService.cs`
- `Dynamics365ImportData/Dynamics365ImportData/Comparison/ErrorComparisonReportService.cs`
- `Dynamics365ImportData/Dynamics365ImportData.Tests/Unit/Comparison/ErrorComparisonReportServiceTests.cs`
- `Dynamics365ImportData/Dynamics365ImportData.Tests/Integration/Comparison/CompareErrorsCommandTests.cs`

**Modified files:**
- `Dynamics365ImportData/Dynamics365ImportData/CommandHandler.cs` -- added IErrorComparisonService + IErrorComparisonReportService to constructor, --compare flag on 3 migration commands, GenerateComparisonReportAsync helper, compare-errors/ce standalone command
- `Dynamics365ImportData/Dynamics365ImportData/Program.cs` -- added DI registration for IErrorComparisonReportService (Transient)
- `Dynamics365ImportData/Dynamics365ImportData.Tests/Integration/Pipeline/ExitCodeTests.cs` -- updated CreateCommandHandler with new mock parameters
